<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.12.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEML2: main</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
window.MathJax = {
  loader: {load: ['[tex]/ams', '[tex]/physics', '[tex]/boldsymbol']},
  tex: {packages: {'[+]': ['ams', 'physics', 'boldsymbol']},
        tags: 'ams'}
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <!-- Demo animations -->
  <script type="text/javascript" src="anime.min.js"></script>
  <script type="text/javascript" src="work-dispatcher.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler.js"></script>
  <script type="text/javascript" src="simple-scheduler-demo.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler-demo.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init();
    DoxygenAwesomeParagraphLink.init();
    DoxygenAwesomeInteractiveToc.init();
    DoxygenAwesomeTabs.init();
    SimpleSchedulerDemo.init();
    StaticHybridSchedulerDemo.init();
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">NEML2<span
                    id="projectnumber">&#160;2.0.0</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2runner_2work_2neml2_2neml2_2doc_2content_2tutorials_2models_2implicit__model_2main.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">main</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1 empty">
    <ul>
      <li class="level2">
        <a href="#autotoc_md88">Problem description</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md89">Defining the system of equations</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md90">Solving the system of equations</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md91">Remarks on the implicit function theorem</a>
      </li>
    </ul>
  </li>
</ul>
</div>
<div class="textblock"><p>@insert-title:tutorials-models-implicit-model</p>
<h2><a class="anchor" id="autotoc_md88"></a>
Problem description</h2>
<p>One of the most notable differences between constitutive models and feed-forward neural networks is that updating certain stiff systems with implicit methods is often more computationally efficient compared to explicit algorithms.</p>
<p>A generally nonlinear, recursive, implicit system of equations take the following form    </p><p class="formulaDsp">
\begin{align*}
  \mathbf{r}(\tilde{\mathbf{s}}) &amp; = f(\tilde{\mathbf{s}}, \mathbf{f}, \mathbf{s}_n, \mathbf{f}_n; \mathbf{p}), \\
  \mathbf{s} &amp;= \mathop{\mathrm{root}}\limits_{\tilde{\mathbf{s}}} (\mathbf{r}).
\end{align*}
</p>
<p> Here \( \mathbf{r} \) represents the residual (for root-fiding) of the system of equations, and \( \mathbf{s} \), \( \mathbf{f} \), \( \mathbf{s}_n \), \( \mathbf{f}_n \) are defined by four reserved sub-axes in NEML2:</p><ul>
<li>The <code>state</code> sub-axis hosts input variables in set \( \tilde{\mathbf{s}} \). The variables on this sub-axis are the primary unknowns to be solved for. After solving the system, the <code>state</code> sub-axis hosts output variables in set \( \mathbf{s} \).</li>
<li>The <code>forces</code> sub-axis hosts <em>prescribed</em> input variables in set \( \mathbf{f} \). These variables are prescribed and, by definition, do not change while the system is being solved.</li>
<li>The <code>old_state</code> and <code>old_forces</code> sub-axes respectively correspond to \( \mathbf{s}_n \) and \( \mathbf{f}_n \). These variables correspond to the <em>previous</em> solution to the system to facilitate the recursive definition of internal variables in history-dependent models. The equivalent plastic strain in plasticity models is a well-known example.</li>
</ul>
<p>The Perzyna viscoplasticity model mentioned in a <a class="el" href="tutorials-models-model-composition.html">previous tutorial</a> takes this form:         </p><p class="formulaDsp">
\begin{align}
  \boldsymbol{\varepsilon}^e &amp; = \boldsymbol{\varepsilon} - \boldsymbol{\varepsilon}^p, \label{1} \\
  \boldsymbol{\sigma} &amp; = 3K\operatorname{vol}\boldsymbol{\varepsilon}^e + 2G\operatorname{dev}\boldsymbol{\varepsilon}^e, \label{2} \\
  \bar{\sigma} &amp; = J_2(\boldsymbol{\sigma}), \label{3} \\
  f^p &amp; = \bar{\sigma} - \sigma_y, \label{4} \\
  \boldsymbol{N} &amp; = \pdv{f^p}{\boldsymbol{\sigma}}, \label{5} \\
  \dot{\gamma} &amp; = \left( \dfrac{\left&lt; f^p \right&gt;}{\eta} \right)^n, \label{6} \\
  \dot{\boldsymbol{\varepsilon}}^p &amp; = \dot{\gamma} \boldsymbol{N}. \label{7}
\end{align}
</p>
<p> Its residual can be defined using backward-Euler time integration as   </p><p class="formulaDsp">
\begin{align}
  \mathbf{r}\left( \boldsymbol{\varepsilon}^p \right) = \boldsymbol{\varepsilon}^p - \boldsymbol{\varepsilon}^p_n - \left( t - t_n \right) \dot{\boldsymbol{\varepsilon}}^p, \label{8}
\end{align}
</p>
<p> the solution procedure of which is often referred to as the <em>return-mapping algorithm</em> in the solid mechanics community.</p>
<p>This tutorial illustrates the use of <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a> in conjunction with a Newton-Raphson solver to perform the implicit update.</p>
<h2><a class="anchor" id="autotoc_md89"></a>
Defining the system of equations</h2>
<p>After searching among existing models provided by NEML2, we are able to translate each of these equations into a NEML2 model. The input file looks like</p>
<p>@list:input:implicit_model/input1.i</p>
<p>Note the one-to-one correspondance between the models and the equations.</p>
<p>The structure of the system of equations can be summarized using the code below.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> @list:cpp:implicit_model/ex1.cxx</p>
<p class="startli">Output: @list-output:ex1</p>
</li>
<li><p class="startli"><b class="tab-title">Python</b> @list:python:implicit_model/ex2.py</p>
<p class="startli">Output: @list-output:ex2</p>
</li>
</ul>
</div><div class="tabbed"></div><h2><a class="anchor" id="autotoc_md90"></a>
Solving the system of equations</h2>
<p>Once the system of equations are properly defined, we can use the <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a> to solve the system of equations. The <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a> is responsible for the following:</p><ul>
<li>(Re)declare the solution to the system of equations as output variables.</li>
<li>Validate the shape of input variables and residual variables to make sure the system is square.</li>
<li>Assemble the residual vector and Jacobian matrix of the underlying linear system.</li>
<li>Invoke a <em>solver</em> to solve the system of equations.</li>
<li>Apply the implicit function theorem to calculate exact derivatives (up to machine precision).</li>
</ul>
<p>NEML2 offers three fully vectorized Newton solvers to be used in conjunction with <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a>:</p><ul>
<li><a class="el" href="syntax-solvers.html#newton">Newton</a>, the (vectorized) vanilla version of the Newton-Raphson algorithm which always takes the "full" step.</li>
<li><a class="el" href="syntax-solvers.html#newtonwithlinesearch">NewtonWithLineSearch</a>, similar to Newton but offers several commonly used (again fully vectorized) line search strategies.</li>
<li><a class="el" href="syntax-solvers.html#newtonwithtrustregion">NewtonWithTrustRegion</a>, the trust-region variant of the Newton-Raphson algorithm, where a scalar-valued, fully vectorized quadratic sub-problem is solved to identify the search direction in each update.</li>
</ul>
<p>In addition, the assembly routines as well as the application of the implicit function theorem are also implemented in a vectorized fashion.</p>
<p>The additional sections needed in the input file are @list-input:implicit_model/input2.i:Models/model,Solvers/newton</p>
<p>The <a class="el" href="syntax-models.html#implicitupdate">ImplicitUpdate</a> model can then be invoked in the same way as regular models.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><p class="startli"><b class="tab-title">C++</b> @list:cpp:implicit_model/ex3.cxx</p>
<p class="startli">Output: @list-output:ex3</p>
</li>
<li><p class="startli"><b class="tab-title">Python</b> @list:cpp:implicit_model/ex4.py</p>
<p class="startli">Output: @list-output:ex4</p>
</li>
</ul>
</div><div class="tabbed"></div><h2><a class="anchor" id="autotoc_md91"></a>
Remarks on the implicit function theorem</h2>
<p>Unlike other regular models, declaring variables on the <em>correct</em> sub-axes is important because NEML2 relies on the reserved sub-axes (<code>state</code>, <code>forces</code>, etc.)</p><ul>
<li>To determine whether the variable value and derivatives should be calculated during the assembly of residual and Jacobian. For example, the derivatives with respect to all variables on the <code>forces</code> sub-axis are skipped because they are not required in the assembly of the linear system.</li>
<li>To efficiently reuse the factorization of the system Jacobian when applying the implicit function theorem.</li>
</ul>
<p>As long as models are defined using the <em>correct</em> sub-axis definitions and satisfy some mild continuity requirements, <b>NEML2 guarantees the correctness of the variable derivatives</b> after one or more implicit updates, up to machine precision. The same guarantee also applies to user-defined custom models.</p>
<p>This is a significant advantage compared to some of the alternative constitutive model libraries, especially in the context of coupling with external PDE solvers. For example, in the context of finite element method, thermodynamic forces (e.g. strain) are calculated at each quadrature point, and the constitutive library (e.g. NEML2) is responsible for updating the thermodynamic state variables (e.g. stress, plastic strain, etc.), which are then used in the residual definition of the discretized PDE. Therefore, the exact derivatives of the state variables with respect to the forces are the key to the assembly of the exact Jacobian of the descretized PDE, which is in turn the fundamental requirement for optimal convergence for many nonlinear solvers.</p>
<p>@insert-page-navigation </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
