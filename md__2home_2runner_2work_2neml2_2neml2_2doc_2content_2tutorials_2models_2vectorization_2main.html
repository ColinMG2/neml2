<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
  <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=11" />
  <meta name="generator" content="Doxygen 1.12.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEML2: main</title>
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="dynsections.js"></script>
  <script type="text/javascript" src="clipboard.js"></script>
  <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
  <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
  <script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
window.MathJax = {
  loader: {load: ['[tex]/ams', '[tex]/physics', '[tex]/boldsymbol']},
  tex: {packages: {'[+]': ['ams', 'physics', 'boldsymbol']},
        tags: 'ams'}
};
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-tabs.js" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
  <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
  <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
  <script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
  <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
  <!-- Demo animations -->
  <script type="text/javascript" src="anime.min.js"></script>
  <script type="text/javascript" src="work-dispatcher.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler.js"></script>
  <script type="text/javascript" src="simple-scheduler-demo.js"></script>
  <script type="text/javascript" src="static-hybrid-scheduler-demo.js"></script>
  <script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init();
    DoxygenAwesomeParagraphLink.init();
    DoxygenAwesomeInteractiveToc.init();
    DoxygenAwesomeTabs.init();
    SimpleSchedulerDemo.init();
    StaticHybridSchedulerDemo.init();
  </script>
</head>
<body>
    <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
      <div id="titlearea">
        <table cellspacing="0" cellpadding="0">
          <tbody>
            <tr id="projectrow">
              <td id="projectalign">
                <div id="projectname">NEML2<span
                    id="projectnumber">&#160;2.0.0</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2runner_2work_2neml2_2neml2_2doc_2content_2tutorials_2models_2vectorization_2main.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">main</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1 empty">
    <ul>
      <li class="level2">
        <a href="#autotoc_md120">What is vectorization?</a>
      </li>
      <li class="level2">
        <a href="#autotoc_md121">For loop versus vectorization: A numerical experiment</a>
        <ul>
          <li class="level3">
            <a href="#autotoc_md122">For loop</a>
          </li>
          <li class="level3">
            <a href="#autotoc_md123">Vectorization</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#autotoc_md124">Remarks</a>
      </li>
    </ul>
  </li>
</ul>
</div>
<div class="textblock"><p>@insert-title:tutorials-models-vectorization</p>
<h2><a class="anchor" id="autotoc_md120"></a>
What is vectorization?</h2>
<p>Vectorization refers to <em>array programming</em>. Both SIMD (single instruction, multiple data) operation and SIMT (single instruction, multiple threads) operation are implementations of array programming. These terms all refer to the methods that apply operations to an entire set of values at once.</p>
<p>While the benefit of vectorization depends on the instruction support, instruction throughput, and register size, among other factors, it is generally expected that vectorization can provide a considerable amount of speedup to many operations. For example, given a device's instruction set with 1024-bit registers. These can be used to operate on 16 operands of 64-bits apiece. More specifically, if we are dealing with double-precision floating point numbers, a single instruction can do 16 operations at once. In other words, ideally, \( N \) operations can be completed using \( N/16 \) instructions. And again, ideally, this leads to 16 times faster execution than operations without vectorization.</p>
<p>Although the implementation varies, both CPU and CUDA supports vectorization. NEML2 supports vectorization of model evaluation on both CPU and CUDA. All NEML2 models ensure that the data being processed, e.g., variables, parameters, buffers, are contiguously allocated, and that the same set of operations are applied to those contiguous chunks of data.</p>
<h2><a class="anchor" id="autotoc_md121"></a>
For loop versus vectorization: A numerical experiment</h2>
<p>Given the material model we have been working with in the previous tutorials, how much (wall clock) time would it take to perform 100,000 forward evaluations?</p>
<p>There are two ways of completing this task:</p><ul>
<li>using a for loop, or</li>
<li>using vectorization</li>
</ul>
<h3><a class="anchor" id="autotoc_md122"></a>
For loop</h3>
<p>The following code snippet shows how to use a for loop to perform the \( N \) evaluations. For convenience, the \( N \) strains are evenly spaced.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><b class="tab-title">C++</b> @list:cpp:vectorization/ex1.cxx</li>
<li><b class="tab-title">Python</b> @list:python:vectorization/ex2.py</li>
</ul>
</div><div class="tabbed"></div><h3><a class="anchor" id="autotoc_md123"></a>
Vectorization</h3>
<p>The following code snippet shows how to rely on NEML2 internal vectorization to perform the \( N \) evaluations.</p>
<div class="tabbed"></div><div class="tabbed"><ul>
<li><b class="tab-title">C++</b> @list:cpp:vectorization/ex3.cxx</li>
<li><b class="tab-title">Python</b> @list:python:vectorization/ex4.py</li>
</ul>
</div><div class="tabbed"></div><p>For a fair comparison, the input variables are allocated prior to model evaluation, and only the model evaluation part is timed. The timing study was performed with \( N = \{10, 1000, 100000\} \) on both CPU and CUDA. Results are summarized in the following table.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Device   </th><th class="markdownTableHeadLeft">N   </th><th class="markdownTableHeadLeft">For loop   </th><th class="markdownTableHeadLeft">Vectorization    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CPU   </td><td class="markdownTableBodyLeft">10   </td><td class="markdownTableBodyLeft">0.061   </td><td class="markdownTableBodyLeft">0.003    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">1000   </td><td class="markdownTableBodyLeft">0.232   </td><td class="markdownTableBodyLeft">0.004    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">100000   </td><td class="markdownTableBodyLeft">16.782   </td><td class="markdownTableBodyLeft">0.041    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CUDA   </td><td class="markdownTableBodyLeft">10   </td><td class="markdownTableBodyLeft">0.145   </td><td class="markdownTableBodyLeft">0.004    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">1000   </td><td class="markdownTableBodyLeft">0.337   </td><td class="markdownTableBodyLeft">0.004    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft"></td><td class="markdownTableBodyLeft">100000   </td><td class="markdownTableBodyLeft">26.176   </td><td class="markdownTableBodyLeft">0.005   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md124"></a>
Remarks</h2>
<p>While there are many other factors contributing to the performance difference between the for loop approach and the vectorization approach, we hope this simple experiment serves as a reasonable introduction to the benefit of vectorization.</p>
<p>It is worth noting that, in the above code snippets,</p><ul>
<li>The pre-allocated strain tensor has a shape of <code>(N; 6)</code>. The leading dimension with size N is referred to as a <em>batch dimension</em> in NEML2.</li>
<li>The strain tensor with shape <code>(N; 6)</code> can operate with scalar-valued model parameters \( K \) and \( G \). This behavior relies on the concept of <em>broadcasting</em>.</li>
</ul>
<p><em>Batching</em> and <em>broadcasting</em> are the fundamental mechanisms that allow NEML2 to efficiently vectorize model evaluation while providing users with a unified API for both CPU and CUDA. More details on these mechanisms are discussed in the <a class="el" href="tutorials-tensors.html">tutorials</a> on NEML2 tensors.</p>
<p>@insert-page-navigation </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
